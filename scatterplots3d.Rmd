---
title: "European Revision"
output: html_notebook
---

Checking out the scatterplot data of the GEZ and forest.  I took a random sampling of points, 2000 points per zone.  I then extracted the data for:

1. [Mean annual temperature](https://developers.google.com/earth-engine/datasets/catalog/WORLDCLIM_V1_BIO)
2. [Elevation](https://developers.google.com/earth-engine/datasets/catalog/USGS_GMTED2010)
3. [SPEI](https://developers.google.com/earth-engine/datasets/catalog/ECMWF_ERA5_MONTHLY)

I calculated the SPEI using the [SPEI package](https://cran.r-project.org/web/packages/SPEI/index.html) in R and calculated the mean SPEI for the monthly time period between 2000 - 2020.

For the plots below, *pts* represent the random points taken for each GEZ and *sites* represent the primary forest sites in the paper.  The plots are interactive and you can zoom in and out and move axes of the plot, just click on the plot.

```{r libraries, echo = F, results='hide', message=FALSE, error = F, include = F, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(scatterplot3d)
library(FactoClass)
# library(plotly)
```

```{r formatData, echo = F, results='hide', message=FALSE, error = F, include = F, warning=FALSE}

eurPts<-read.csv('E:\\Big_Tree\\data\\Europe\\revision\\europeanPointsExtractEra2.csv')
eurSites<-read.csv('E:\\Big_Tree\\data\\Europe\\revision\\europeanSitesExtractAll.csv')
eurPts$gezValue<-gsub("\\[|\\]","", eurPts$gezValue)
eurSites$gezValue<-gsub("\\[|\\]","", eurSites$gezValue)

#------------------------------------------------------------------------
#sites
#------------------------------------------------------------------------
sites<-data.frame(as.numeric(eurSites$ID), 
                  as.factor(eurSites$Site_Type),
                  as.character(eurSites$gezValue),
                  as.numeric(eurSites$meanSpeiValue),
                  as.numeric(eurSites$minSpeiValue),
                  as.numeric(eurSites$meanTempValue),
                  # as.numeric(eurSitesBioclim$meanTempValue*0.1),
                  as.numeric(eurSites$elevation/100),
                  as.numeric(eurSites$forestCover30Value))

head(sites)
names(sites)<- c('ID', 'type', 'gez', 'meanSpei', 'minSpei', 'meanTemp', 'elevation', 'forest30')

#add rounded data
sites$meanSpeiRd <- round(sites$meanSpei, 2)
sites$minSpeiRd <- round(sites$minSpei, 2)

#omit all n/a rows
sites<-na.omit(sites)

sites30 <- dplyr::filter(sites, forest30 %in% c(1))
head(sites30)

#------------------------------------------------------------------------
#points
#------------------------------------------------------------------------
eurPts$type <- "pts"
pts<-data.frame(as.numeric(eurPts$CID + 6870),
                as.factor(eurPts$type),
                as.character(eurPts$gezValue), 
                as.numeric(eurPts$meanSpeiValue), 
                as.numeric(eurPts$minSpeiValue), 
                as.numeric(eurPts$meanTempValue),  
                as.numeric(eurPts$elevation/100),
                as.numeric(eurPts$forestCover30Value))
head(pts)
names(pts)<- c('ID', 'type', 'gez', 'meanSpei', 'minSpei', 'meanTemp', 'elevation', 'forest30')

#add rounded data
pts$meanSpeiRd <- round(pts$meanSpei, 2)
pts$minSpeiRd <- round(pts$minSpei, 2)

#omit all n/a rows
pts<-na.omit(pts)

pts30 <- dplyr::filter(pts, forest30 %in% c(1))

head(pts30)

#-------------------------
combine<-rbind(pts30, sites30)

```

```{r plotLimits,echo=FALSE, message=FALSE, warning=FALSE}
max_x <- max(combine$meanTemp) #mean Annual temp
min_x <- min(combine$meanTemp)
max_y <- max(combine$meanSpei) #mean SPEI value
min_y <- min(combine$meanSpei)
max_z <- max(combine$elevation) #mean Annual temp
min_z <- min(combine$elevation)

```

```{r borealConiferous, echo=FALSE, message=FALSE, warning=FALSE}

#Look at 3d scatterplot
gezType <-'Boreal coniferous forest'
combinePts<-dplyr::filter(combine,gez == gezType )
colourCombo <- c("#98FB9825", "#00FFFF", "#FFFF66", "#FF5733")
# Pale Green: #98FB98 pts
# Red: #FF5733 research sites
# Aqua: #00FFFF literature sites
# Yellow: #FFFF66 inventory sites
colours<-colourCombo[as.numeric(combinePts$type)]
# scatterplot3d(x = combinePts$meanTemp, 
#               y = combinePts$meanSpei, 
#               z = combinePts$elevation,
#               pch = 20,
#               color = colours,
#               angle = 70,
#               main = gezType,
#               xlab = "Mean annual Temperature(°C)",
#               ylab = "Water availability index",
#               zlab = "Elevation (100m)",
#               xlim=c(min_x,max_x),
#               ylim=c(min_y,max_y),
#               zlim=c(0,max_z)
#               )
# legend()

# source('~/hubiC/Documents/R/function/addgrids3d.r')
s3d <- scatterplot3d(x = combinePts$meanTemp, 
              y = combinePts$meanSpei, 
              z = combinePts$elevation,
              pch = "",
              grid = F,
              box = T,
              # angle = 70,
              # color = colours,
              main = gezType,
              xlab = "Mean annual Temperature(°C)",
              ylab = "Water availability index",
              zlab = "Elevation (100m)",
              xlim=c(min_x,max_x),
              ylim=c(min_y,max_y),
              zlim=c(0,max_z)
              )

addgrids3d(x = combinePts$meanTemp, 
           y = combinePts$meanSpei, 
           z = combinePts$elevation,
           grid = c("xy", "xz", "yz"),
           xlim=c(min_x,max_x),
           ylim=c(min_y,max_y),
           zlim=c(0,max_z)
           )
s3d$points3d(x = combinePts$meanTemp, 
              y = combinePts$meanSpei,
              z = combinePts$elevation,
              pch = 20,
              col= colours)

legend(s3d$xyz.convert(150, 1.5, -7),
       legend = levels(combine$type),
       col = colourCombo,
       pch = 20,
       cex = 0.75,
       inset = 0.00, xpd = TRUE, horiz = F)
```

```{r borealMs, echo=FALSE, message=FALSE, warning=FALSE}

#Look at 3d scatterplot
gezType <-'Boreal mountain system'
# ppPts<-dplyr::filter(pts30, id == 'pts' & gez == gezType )
combinePts<-dplyr::filter(combine, gez == gezType )


plot_ly(combinePts, x = ~meanTemp,y = ~meanSpeiRd, z = ~elevation , color = ~id, colors = c('#FF99A9', '#0C4B8E'), opacity = 0.85, marker = list(size = 2))%>%
  layout(title = gezType)

```

```{r TemperateContinental Forest, echo=FALSE, message=FALSE, warning=FALSE}

#Look at 3d scatterplot
gezType <-'Temperate continental forest'
# ppPts<-dplyr::filter(pts30, id == 'pts' & gez == gezType )
combinePts<-dplyr::filter(combine, gez == gezType )

plot_ly(combinePts, x = ~meanTemp,y = ~meanSpeiRd, z = ~elevation , color = ~id, colors = c('#FF99A9', '#0C4B8E'), opacity = 0.85, marker = list(size = 2))%>%
  layout(title = gezType)

```

```{r TemperateMountainSystem, echo=FALSE, message=FALSE, warning=FALSE}

#Look at 3d scatterplot
gezType <-'Temperate mountain system'
# ppPts<-dplyr::filter(pts30, id == 'pts' & gez == gezType )
combinePts<-dplyr::filter(combine, gez == gezType )


plot_ly(combinePts, x = ~meanTemp,y = ~meanSpeiRd, z = ~elevation , color = ~id, colors = c('#FF99A9', '#0C4B8E'), opacity = 0.85, marker = list(size = 2))%>%
  layout(title = gezType)
```

```{r TemperateOceanicForest, echo=FALSE, message=FALSE, warning=FALSE}

#Look at 3d scatterplot
gezType <-'Temperate oceanic forest'
# ppPts<-dplyr::filter(pts30, id == 'pts' & gez == gezType )
combinePts<-dplyr::filter(combine, gez == gezType )


plot_ly(combinePts, x = ~meanTemp,y = ~meanSpeiRd, z = ~elevation , color = ~id, colors = c('#FF99A9', '#0C4B8E'), opacity = 0.85, marker = list(size = 2))%>%
  layout(title = gezType)

```

```{r SubtropicalMountainSystem, echo=FALSE, message=FALSE, warning=FALSE}

#Look at 3d scatterplot
gezType <-'Subtropical mountain system'
# ppPts<-dplyr::filter(pts30, id == 'pts' & gez == gezType )
combinePts<-dplyr::filter(combine, gez == gezType )

plot_ly(combinePts, x = ~meanTemp,y = ~meanSpeiRd, z = ~elevation , color = ~id, colors = c('#FF99A9', '#0C4B8E'), opacity = 0.85, marker = list(size = 2))%>%
  layout(title = gezType)

```

```{r SubtropicalDryForest, echo=FALSE, message=FALSE, warning=FALSE}

#Look at 3d scatterplot
gezType <-'Subtropical dry forest'
# ppPts<-dplyr::filter(pts30, id == 'pts' & gez == gezType )
combinePts<-dplyr::filter(combine, gez == gezType )


plot_ly(combinePts, x = ~meanTemp,y = ~meanSpeiRd, z = ~elevation , color = ~id, colors = c('#FF99A9', '#0C4B8E'), opacity = 0.85, marker = list(size = 2))%>%
  layout(title = gezType)

```

